<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Makale Gönder</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="container">
        <h1>Makale Gönder</h1>
        <form id="makaleForm">
            <input type="text" id="title" placeholder="Makale Başlığı" required />
            <textarea id="description" placeholder="Açıklama" required></textarea>
            <input type="text" id="keywords" placeholder="Anahtar Kelimeler" required />
            <input type="text" id="pdfUrl" placeholder="Pdf Url" />
            <input type="text" id="supportingInstitution" placeholder="Destekleyen Kurum" />
            <input type="text" id="projectNumber" placeholder="Proje Numarası" />
            <input type="text" id="reference" placeholder="Referans" />
            <input type="url" id="articleLink" placeholder="Makale Linki" />
            <input type="text" id="issueId" placeholder="Sayı ID (GUID)" required />
            <input type="text" id="authorIds" placeholder="Yazar ID'leri (GUID, virgülle ayrılmış)" required />
            <button type="submit">Gönder</button>
        </form>
    </div>

    <script>
        const token = localStorage.getItem("jwtToken");
        const role = localStorage.getItem("userRole");

        if (role !== "User") {
            alert("Yetkisiz erişim. Lütfen giriş yapınız.");
            window.location.href = "login.html";
        }

        document.getElementById("makaleForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const authorIdsRaw = document.getElementById("authorIds").value;
            const authorIds = authorIdsRaw.split(',').map(id => id.trim()).filter(id => id.length > 0);

            const articleCreateDto = {
                title: document.getElementById("title").value,
                description: document.getElementById("description").value,
                keywords: document.getElementById("keywords").value,
                pdfUrl: document.getElementById("pdfUrl").value,
                supportingInstitution: document.getElementById("supportingInstitution").value,
                projectNumber: document.getElementById("projectNumber").value,
                reference: document.getElementById("reference").value,
                articleLink: document.getElementById("articleLink").value,
                issueId: document.getElementById("issueId").value,
                authorIds: authorIds,
                isApproved: false
            };

            try {
                const response = await fetch("https://localhost:7198/api/Article", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(articleCreateDto)
                });

                console.log("API yanıt:", response);

                if (response.ok) {
                    alert("Makaleniz başarıyla gönderildi! Onay bekliyor.");
                    document.getElementById("makaleForm").reset();
                } else {
                    const errorText = await response.text();
                    console.error("Gönderim hatası:", errorText);
                    alert("Gönderim başarısız:\n" + errorText);
                }
            } catch (err) {
                console.error("İstek hatası:", err);
                alert("Sunucuya bağlanırken bir hata oluştu.");
            }
        });
    </script>
</body>
</html>
